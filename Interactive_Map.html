<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>New York Map</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        svg { border: 1px solid #ccc; margin-top: 10px; }
        path:hover { cursor: pointer; }
    </style>
</head>
<body>
    <h2>Map of New York</h2>
    <svg id="map" width="800" height="600"></svg>

    <script>
        console.log("D3 version:", d3.version); 
        const width = 800, height = 600;
        const svg = d3.select("#map").attr("width", width).attr("height", height);

        // Create a group to contain the map features
        const g = svg.append("g");

        // Define projections
        proj4.defs("EPSG:2263", "+proj=lcc +lat_1=40.66666666666666 +lat_2=41.03333333333333 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000.0000000001 +y_0=0 +units=us-ft +no_defs");
        const proj2263 = proj4("EPSG:2263");
        const projWGS84 = proj4("EPSG:4326");

        // Function to reproject coordinates
        function reproject(coords) {
            if (typeof coords[0] === 'number') {
                return proj4(proj2263, projWGS84, coords);
            } else {
                return coords.map(reproject);
            }
        }

        // Load the TopoJSON file
        d3.json("nynta2020repro.json").then(data => {
            console.log("TopoJSON structure:", data);
            const key = Object.keys(data.objects)[0];
            const features = topojson.feature(data, data.objects[key]).features;

            // Reproject the coordinates of each feature
            features.forEach(feature => {
                feature.geometry.coordinates = reproject(feature.geometry.coordinates);
            });

            // Set up the projection
            const projection = d3.geoMercator()
                .fitSize([width, height], { type: "FeatureCollection", features: features });

            const path = d3.geoPath().projection(projection);

            g.selectAll("path")
                .data(features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", "#69b3a2")
                .attr("stroke", "#fff")
                .on("mouseover", function() {
                    d3.select(this).attr("fill", "#1f77b4");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("fill", "#69b3a2");
                })
                .on("click", (event, d) => {
                    try {
                        // Get the bounds of the clicked feature
                        const bounds = path.bounds(d);
                        console.log("Bounds of clicked feature:", JSON.stringify(bounds));

                        // Ensure bounds are valid
                        if (!bounds || bounds.length !== 2 || bounds.some(arr => arr.some(v => isNaN(v) || !isFinite(v)))) {
                            console.warn("Invalid bounds, cannot apply zoom. Bounds:", JSON.stringify(bounds));
                            return; 
                        }

                        const [[x0, y0], [x1, y1]] = bounds;
                        const dx = x1 - x0;
                        const dy = y1 - y0;
                        const x = (x0 + x1) / 2;
                        const y = (y0 + y1) / 2;
                        const scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height)));
                        const translate = [width / 2 - scale * x, height / 2 - scale * y];

                        // Apply zoom transformation with a smooth transition
                        g.transition()
                            .duration(750)
                            .attr("transform", `translate(${translate})scale(${scale})`);
                    } catch (e) {
                        console.error("Error during zoom operation:", e);
                    }
                });
        }).catch(error => {
            console.error("Error loading TopoJSON file:", error);
        });
    </script>
</body>
</html>
